# Trade_2.py - 实盘动态对冲交易策略

## 📋 概述

`trade_2.py` 是一个高级的加密货币动态对冲交易策略，专门设计用于在 Aster Finance 和 Backpack Exchange 两个平台之间进行实盘对冲交易。该策略通过同时开启相反方向的仓位来对冲市场风险，并通过智能的限价平单机制实现盈利。

## 🎯 核心功能

### 1. 双平台对冲交易
- **Aster Finance**: 开启空单（做空）
- **Backpack Exchange**: 开启多单（做多）
- **对冲原理**: 通过相反方向的仓位抵消市场波动风险

### 2. 智能限价平单策略
- **止损机制**: 0.8% 自动止损保护
- **限价获利**: 1.2% 限价单获利目标
- **动态调整**: 根据市场情况自动调整平仓策略

### 3. 实时监控系统
- **价格监控**: 实时获取两个平台的价格数据
- **PnL计算**: 动态计算每个仓位的盈亏状态
- **风险控制**: 自动监控并执行风险管理规则

## 🚀 主要特性

### 交易模式
1. **连续交易模式**: 持续运行，自动执行多轮交易
2. **单轮交易模式**: 执行一次完整的开仓-监控-平仓周期

### 风险管理
- **止损保护**: 0.8% 止损阈值，及时止损避免大额亏损
- **盈利目标**: 1.2% 盈利目标，通过限价单锁定利润
- **强制平仓**: 达到最大监控时间后强制平仓所有仓位

### 限价单功能
- **自动设置**: 盈利仓位自动设置限价单
- **状态监控**: 实时检查限价单执行状态
- **智能平仓**: 根据市场情况选择最优平仓方式

## 📊 交易逻辑

### 开仓策略
```
1. 获取当前市场价格
2. 计算相等仓位大小
3. Aster开空单 + Backpack开多单
4. 记录仓位信息并开始监控
```

### 平仓策略
```
单仓位场景:
- 亏损 ≥ 0.8% → 立即止损
- 盈利 ≥ 1.2% → 设置限价单获利

双仓位场景:
- 亏损方 ≥ 0.8% → 止损平仓
- 盈利方 → 设置限价单继续持有
```

### 限价单管理
```
1. 盈利仓位自动设置1.2%限价单
2. 实时监控限价单状态
3. 成交后自动平仓对应仓位
4. 未成交时根据市场情况调整
```

## 🛠️ 技术架构

### API集成
- **Aster Finance API**: 处理空单交易和仓位管理
- **Backpack Exchange API**: 处理多单交易和限价单
- **异步处理**: 使用 asyncio 实现高效的异步API调用

### 数据结构
```python
@dataclass
class Position:
    position_id: str        # 仓位ID
    platform: str          # 交易平台
    symbol: str            # 交易对
    side: PositionSide     # 多空方向
    amount: float          # 仓位数量
    entry_price: float     # 开仓价格
    current_price: float   # 当前价格
    status: PositionStatus # 仓位状态
    pnl: float            # 盈亏金额
    pnl_percentage: float # 盈亏百分比
    order_id: str         # 订单ID
```

### 核心类和方法

#### RealDynamicHedgeStrategy 主类
- `execute_real_dynamic_hedge()`: 执行动态对冲交易
- `_monitor_and_close_real_positions()`: 监控和平仓管理
- `_execute_real_closing_logic()`: 执行平仓逻辑

#### 限价单相关方法
- `_set_profit_limit_order()`: 设置盈利限价单
- `_check_limit_order_status()`: 检查限价单状态
- `_cancel_limit_order()`: 取消限价单

#### 仓位管理方法
- `_open_real_hedge_positions()`: 开启对冲仓位
- `_close_real_position()`: 平仓指定仓位
- `_force_close_all_real_positions()`: 强制平仓所有仓位

## 📈 策略参数

### 默认配置
```python
stop_loss_threshold: 0.008      # 0.8% 止损阈值
profit_target_rate: 0.012       # 1.2% 盈利目标
position_size_usdt: 25.0        # 25 USDT 仓位大小
aster_leverage: 1.0             # Aster 1倍杠杆
monitoring_interval: 5.0        # 5秒监控间隔
```

### 可调整参数
- **仓位大小**: 根据资金量调整每次交易金额
- **止损阈值**: 根据风险承受能力调整止损点
- **盈利目标**: 根据市场波动调整获利目标
- **监控频率**: 根据需要调整价格检查频率

## 🔧 使用方法

### 1. 环境准备
```bash
# 安装依赖
pip install -r requirements.txt

# 配置API密钥
# 编辑 aster/config.json 和 backpack/config.json
```

### 2. 运行策略
```bash
python trade_2.py
```

### 3. 选择模式
```
🚀 动态对冲策略启动器
1. 连续交易模式 (推荐)
2. 单轮交易模式
请选择模式 (1/2):
```

### 4. 监控输出
```
📊 监控   1: 开仓价 $208.07 | 当前价 $208.07 | 变化率 +0.00%
💰 市场价格: Backpack $208.07 | Aster $208.03 | 活跃仓位: 2
🔴 Aster 空单: 0.2400 SOL | 买入价 $208.01 | 当前价 $208.03 | PnL: -0.01%
🟢 Backpack 多单: 0.2400 SOL | 买入价 $208.07 | 当前价 $208.07 | PnL: +0.00%
⚖️  对冲总PnL: $-0.00 | 价差: $0.04
```

## ⚠️ 风险提示

### 交易风险
- **市场风险**: 极端市场条件下可能出现滑点和流动性问题
- **技术风险**: API连接中断或延迟可能影响交易执行
- **资金风险**: 请确保有足够的资金余额支持交易

### 使用建议
1. **小额测试**: 首次使用建议用小额资金测试
2. **监控运行**: 运行期间请保持监控，及时处理异常
3. **网络稳定**: 确保网络连接稳定，避免API调用失败
4. **资金管理**: 合理设置仓位大小，不要超过风险承受能力

## 📝 日志和监控

### 日志级别
- **INFO**: 正常交易信息和状态更新
- **WARNING**: 警告信息，如API连接问题
- **ERROR**: 错误信息，需要关注和处理

### 关键监控指标
- **仓位状态**: 实时监控各仓位的盈亏情况
- **价格差异**: 监控两个平台的价格差异
- **限价单状态**: 跟踪限价单的执行情况
- **总体PnL**: 监控整体策略的盈亏表现

## 🔄 更新日志

### 最新版本特性
- ✅ 修复了 decimal.Decimal 类型转换问题
- ✅ 优化了限价单设置和监控逻辑
- ✅ 改进了错误处理和重试机制
- ✅ 增强了实时监控和日志输出

### 测试覆盖
- ✅ 限价单设置功能测试
- ✅ 限价单状态检查测试
- ✅ 平仓逻辑测试
- ✅ 强制平仓功能测试

## 📞 技术支持

如遇到问题或需要技术支持，请检查：
1. API配置是否正确
2. 网络连接是否稳定
3. 资金余额是否充足
4. 日志输出中的错误信息

---

**免责声明**: 本策略仅供学习和研究使用，实盘交易存在风险，请谨慎使用并自行承担风险。